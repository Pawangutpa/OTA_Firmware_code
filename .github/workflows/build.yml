name: Firmware CI/CD OTA Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout firmware repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3Ô∏è‚É£ Install PlatformIO
      - name: Install PlatformIO
        run: |
          pip install --upgrade pip
          pip install platformio

      # 4Ô∏è‚É£ Configure AWS credentials (AWS CLI included)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      # 5Ô∏è‚É£ Read & validate firmware version
      - name: Read firmware version
        id: fw_version
        run: |
          if [ ! -f version.txt ]; then
            echo "‚ùå version.txt missing"
            exit 1
          fi

          VERSION=$(cat version.txt | tr -d '[:space:]')

          if [ -z "$VERSION" ]; then
            echo "‚ùå version.txt is empty"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Firmware version: $VERSION"

      # 6Ô∏è‚É£ Build ESP32 firmware
      - name: Build ESP32 firmware
        run: |
          pio run

      # 7Ô∏è‚É£ Prepare OTA artifacts
      - name: Prepare OTA artifacts
        run: |
          mkdir -p out

          if [ ! -f .pio/build/esp32dev/firmware.bin ]; then
            echo "‚ùå firmware.bin not found"
            exit 1
          fi

          cp .pio/build/esp32dev/firmware.bin out/firmware.bin
          cp version.txt out/version.txt

          cat <<EOF > out/metadata.json
          {
            "device": "esp32dev",
            "version": "${{ steps.fw_version.outputs.version }}",
            "build_type": "production",
            "git_commit": "${{ github.sha }}",
            "build_by": "github-actions",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "firmware_file": "firmware.bin"
          }
          EOF

      # 8Ô∏è‚É£ Upload firmware to S3 (versioned release)
      - name: Upload to S3 (releases)
        run: |
          aws s3 cp out/firmware.bin \
            s3://${{ secrets.S3_BUCKET }}/esp32s3/releases/v${{ steps.fw_version.outputs.version }}/firmware.bin

          aws s3 cp out/version.txt \
            s3://${{ secrets.S3_BUCKET }}/esp32s3/releases/v${{ steps.fw_version.outputs.version }}/version.txt

          aws s3 cp out/metadata.json \
            s3://${{ secrets.S3_BUCKET }}/esp32s3/releases/v${{ steps.fw_version.outputs.version }}/metadata.json

      # 9Ô∏è‚É£ Promote firmware to production
      - name: Promote firmware to production
        run: |
          aws s3 cp out/firmware.bin \
            s3://${{ secrets.S3_BUCKET }}/esp32s3/production/firmware.bin

          aws s3 cp out/version.txt \
            s3://${{ secrets.S3_BUCKET }}/esp32s3/production/version.txt

          aws s3 cp out/metadata.json \
            s3://${{ secrets.S3_BUCKET }}/esp32s3/production/metadata.json
